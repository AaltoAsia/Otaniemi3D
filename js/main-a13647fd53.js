"use strict";angular.module("otaniemi3dApp",["ui.bootstrap","ui.grid","ui.router","ui.event","angular-loading-bar","highcharts-ng"]).config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider",function(e,t,n){function o(e,t,n,o){var a=o.defer();return r(t,o,n).then(function(t){for(var o,r=0;r<t.length;r++)if(t[r].id===e.building){o=t[r];break}o?(n.currentBuilding=o,a.resolve(o)):a.reject("Selected building is not in the database")}),a.promise}function r(e,t,n){var o=t.defer();return n.buildings?o.resolve(n.buildings):e.get("assets/buildings/buildings.json").then(function(e){n.buildings=e.data,o.resolve(e.data)}),o.promise}o.$inject=["$stateParams","$http","buildingData","$q"],r.$inject=["$http","$q","buildingData"],n.strictMode(!1),t.when("",["$state",function(e){e.go("google-maps")}]).when("/google-maps",["$state",function(e){e.go("google-maps")}]).otherwise("not-found"),e.state("google-maps",{url:"/:building",templateUrl:"html/views/google-maps.html",controller:"GoogleMapsCtrl as googleMaps",resolve:{buildings:r}}).state("building",{"abstract":!0,url:"/:building",template:"<ui-view/>",resolve:{currentBuilding:o}}).state("sensor-list",{url:"/sensor-list",templateUrl:"html/views/sensor-list.html",controller:"SensorListCtrl as sensorlist",parent:"building"}).state("heat-map",{url:"/heat-map/:floor/:room",templateUrl:"html/views/heat-map.html",controller:"HeatMapCtrl as heatmap",parent:"building",resolve:{floor:["$stateParams","buildingData","$q","$http",function(e,t,n,o){var a=n.defer(),i=Number(e.floor),s=!1;return r(o,n,t).then(function(){for(var e=t.currentBuilding.floorplans,n=0;n<e.length;n++)if(e[n].floor===i){s=!0;break}s?a.resolve(i):a.reject("Selected building is not in database")}),a.promise}]}}).state("x3dom",{url:"/x3dom/:roomId",templateUrl:"html/views/x3dom.html",controller:"X3DomCtrl as x3dom",parent:"building",params:{roomId:{value:null,squash:!0}}}).state("analytics",{url:"/analytics",templateUrl:"html/views/analytics.html",controller:"AnalyticsCtrl as analytics",parent:"building"}).state("panorama",{url:"/panorama/:roomId",templateUrl:"html/views/panorama.html",controller:"PanoramaCtrl as panorama",parent:"building"}).state("not-found",{url:"{path:.*}",templateUrl:"html/views/not-found.html"})}]).config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]).run(["$rootScope","$state",function(e,t){String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var o=n.indexOf(e,t);return-1!==o&&o===t}),FastClick.attach(document.body);var n=!1;e.$on("$stateChangeError",function(e){t.go("not-found"),n=!0,e.preventDefault()}),e.$on("$locationChangeStart",function(e,t){n&&t.endsWith("/#/")&&(n=!1,e.preventDefault())})}]),angular.module("otaniemi3dApp").controller("GoogleMapsCtrl",["$scope","$timeout","buildingData","$state","$compile",function(e,t,n,o,r){function a(e){for(var t=new google.maps.LatLngBounds,n=0;n<e.coords.length;n++){var o=e.coords[n];t.extend(new google.maps.LatLng(o.lat,o.lng))}return t.getCenter()}function i(t,o){angular.forEach(o,function(r){var a=new google.maps.Polygon({paths:r.coords,strokeColor:h,strokeOpacity:.8,strokeWeight:2,fillColor:f,fillOpacity:.35});a.setMap(t),r.polygon=a,n.currentBuilding&&n.currentBuilding.id===r.id&&a.setOptions({fillColor:h}),google.maps.event.addListener(a,"click",function(){e.$apply(function(){a.setOptions({fillColor:h}),n.currentBuilding=r,angular.forEach(o,function(e){a!==e.polygon&&e.polygon.setOptions({fillColor:f})})})}),google.maps.event.addListener(a,"mouseover",function(){e.$apply(function(){a.setOptions({strokeWeight:4})})}),google.maps.event.addListener(a,"mouseout",function(){e.$apply(function(){a.setOptions({strokeWeight:2})})})}),google.maps.event.addListener(t,"click",function(){e.$apply(function(){angular.forEach(o,function(e){e.polygon.setOptions({fillColor:f})}),m.close(),n.currentBuilding=null})}),google.maps.event.addListener(m,"closeclick",function(){e.$apply(function(){angular.forEach(o,function(e){e.polygon.setOptions({fillColor:f})}),n.currentBuilding=null})})}var s={lat:60.1866142,lng:24.830513},l=16,c={zoom:l,center:s,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},d=new google.maps.Map($("#google-map")[0],c),u=o.params.building,m=new google.maps.InfoWindow({content:r(['<div class="info-window">',"<h4>","{{App.building.name}}","</h4>","<ul>",'<li ng-repeat="nav in App.navigation track by nav.state">','<a class="btn btn-default"','ui-sref="{{nav.state}}({building: App.building.id,',"floor: App.building.floorplans[0].floor,",'room: App.room.id})">',"{{nav.name}}","</a>","</li>","</ul>","</div>"].join(""))(e)[0]});if(u&&u.length){for(var p,g=0;g<n.buildings.length;g++)if(n.buildings[g].id===u){p=n.buildings[g];break}if(!p)return n.currentBuilding=null,void o.go("not-found");n.currentBuilding=p,m.setPosition(a(p)),m.open(d)}var h="#FF0000",f="#808080";t(function(){i(d,n.buildings);var e=d.getCenter();google.maps.event.trigger(d,"resize"),d.setCenter(e)}),e.$watch("App.building",function(e,t){o.transition||e===t||(e?(m.setPosition(a(e)),m.open(d),o.go("google-maps",{building:e.id},{notify:!1,location:"replace"})):o.go("google-maps",{building:""},{notify:!1,location:"replace"}))}),e.$on("reset-position",function(){d.setCenter(s),d.setZoom(l)}),e.$on("room-selection-change",function(t,n){n&&o.go("heat-map",{building:e.App.building.id,floor:n.floor,room:n.id})}),e.$on("destroy",function(){e.$apply(function(){angular.forEach(n.buildings,function(e){google.maps.event.removeInstanceListeners(e.polygon)}),google.maps.event.clearListeners(d,"click"),google.maps.event.clearListeners(m,"closeclick"),m.close()})})}]),angular.module("otaniemi3dApp").controller("HeatMapCtrl",["$scope","buildingData","$modal","$state",function(e,t,n,o){function r(t){e.room=t}function a(e){for(var n=t.currentBuilding.rooms,o=0;o<n.length;o++)if(n[o].id===e)return n[o]}var i=this;e.floor=Number(o.params.floor),e.currentBuilding=t.currentBuilding,e.App.statistics=!0;for(var s=!1,l=0;l<e.currentBuilding.floorplans.length;l++){var c=e.currentBuilding.floorplans[l];if(c.floor===e.floor){s=!0;break}}if(!s)return o.go("not-found"),void(e.floor=1);e.room={},o.params.room&&(e.App.room=a(o.params.room),r(e.App.room)),e.searchString="",e.floorplans=e.currentBuilding.floorplans,e.svgSupport=Modernizr.svg,i.isFloorplanLoaded=!1,e.floorplan=e.floorplans[e.floor-1],e.sensorTypes=[{text:"Temperature",name:"temperature",icon:"assets/shared/images/temperature.svg"},{text:"CO2",name:"co2",icon:"assets/shared/images/co2.svg"},{text:"Humidity",name:"humidity",icon:"assets/shared/images/humidity.svg"},{text:"Light",name:"light",icon:"assets/shared/images/light.svg"},{text:"Occupancy",name:"pir",icon:"assets/shared/images/pir.svg"}];var d=new Date,u=new Date,m=new Date,p=new Date;d.setDate(d.getDate()-1),u.setDate(u.getDate()-7),m.setMonth(m.getMonth()-1),p.setFullYear(p.getFullYear()-1),e.timeFrames=[{text:"Current",icon:"assets/shared/images/latest.svg",params:{}},{text:"Last Week",icon:"assets/shared/images/week.svg",params:{begin:u.toISOString()}},{text:"Last Month",icon:"assets/shared/images/month.svg",params:{begin:m.toISOString()}},{text:"Last Year",icon:"assets/shared/images/year.svg",params:{begin:p.toISOString()}},{text:"Select range",icon:"assets/shared/images/time-range.svg",params:{begin:null,end:null}}],e.sensorType=e.sensorTypes[0],e.timeFrame=e.timeFrames[0],e.selectSensorType=function(t){e.sensorType=t},e.selectTimeFrame=function(t){"Select range"===t.text?(e.modalInstance=n.open({templateUrl:"html/templates/select-range.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{timeRange:{begin:null,end:null}}}}}),e.modalInstance.result.then(function(n){var o=n.timeRange;o.begin&&o.end&&(t.params.begin=o.begin.toISOString(),t.params.end=o.end.toISOString(),e.App.timeFrame=e.timeFrame=t)})):e.App.timeFrame=e.timeFrame=t},e.toggleFullscreen=function(){e.App.fullscreen=!e.App.fullscreen},e.nextFloor=function(){o.go("heat-map",{floor:e.floor+1})},e.prevFloor=function(){o.go("heat-map",{floor:e.floor-1})},e.App.showOptions=function(){e.App.sensorTypes=e.sensorTypes,e.App.sensorType=e.sensorType,e.App.timeFrames=e.timeFrames,e.App.timeFrame=e.timeFrame,e.App.selectOptions=function(t,n){e.sensorType=e.App.sensorType=t,e.selectTimeFrame(n)}},e.mobileModal=function(){i.modalInstance=n.open({templateUrl:"html/templates/sensor-options.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{sensorTypes:e.sensorTypes,sensorType:e.sensorType,timeFrames:e.timeFrames,timeFrame:e.timeFrame,timeRange:{begin:null,end:null}}}}}),i.modalInstance.result.then(function(t){var n=t.timeRange;if(n.begin&&n.end){var o=e.timeFrames.length,r=e.timeFrames[o-1];r.params.begin=n.begin.toISOString(),r.params.end=n.end.toISOString(),e.timeFrame=r}else e.timeFrame=t.timeFrame;e.sensorType=t.sensorType})},e.$on("room-selection-change",function(t,n){n?o.go("heat-map",{building:e.App.building.id,floor:n.floor,room:n.id}):o.go("heat-map",{building:e.App.building.id,floor:e.floor,room:null},{location:"replace",notify:!1})}),e.$on("floorplan-loaded",function(){i.isFloorplanLoaded=!0}),e.$on("$destroy",function(){i.modalInstance&&i.modalInstance.dismiss(),e.App.statistics=!1})}]),angular.module("otaniemi3dApp").controller("SensorListCtrl",["$scope","dataStorage","omiMessage",function(e,t,n){e.gridOptions={enableFiltering:!0,data:t.sensors,columnDefs:[{field:"room"},{field:"name",name:"type"},{field:"values[0].value",name:"value"},{field:"values[0].time.toISOString()",name:"time"}]};var o={Object:{id:{keyValue:"K1"}}};n.send("read",o).then(function(t){e.gridOptions.data=t})}]),angular.module("otaniemi3dApp").controller("X3DomCtrl",["$scope","$modal","$state","$q","$interval","$timeout","$window","omiMessage",function(e,t,n,o,r,a,i,s){function l(){var e=o.defer();return r(function(){i.x3domReady&&e.resolve(!0)},100),a(function(){i.x3domReady||e.reject("Request timed out. Couldn't download x3dom files in 8.0 seconds.")},8e3),e.promise}function c(e){var t={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:e}}}};return s.send("read",t).then(function(e){return e})}e.panoramabox="assets/shared/images/panoramabox.svg",e.selected=void 0,e.webglSupport=Modernizr.webgl,e.building=n.params.building,e.changeView=function(e){var t=$("#3dModel__"+e);return t.length?(t.attr("set_bind","true"),!0):!1},l().then(function(){if(n.params.roomId)for(var t=0;t<e.App.rooms.length;t++)if(n.params.roomId===e.App.rooms[t].id){var o=e.changeView(n.params.roomId);o&&(e.App.room=e.App.rooms[t]);break}}),e.panoramaViewer=function(e){n.go("panorama",{roomId:e})},e.modalTooltip=function(n){e.modalInstance=t.open({templateUrl:"html/templates/sensor-info.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return c(n)}}})},e.$on("reset-position",function(){n.go("x3dom",{building:e.building,roomId:null},{location:"replace",notify:!1}),e.changeView("vp0")}),e.$on("room-selection-change",function(t,o){o&&(n.go("x3dom",{building:e.building,roomId:o.id},{location:"replace",notify:!1}),e.changeView(o.id))}),e.$on("$destroy",function(){e.modalInstance&&e.modalInstance.dismiss()})}]),angular.module("otaniemi3dApp").controller("AnalyticsCtrl",["$scope","$window","omiMessage","$modal",function(e,t,n,o){e.sensor=null,e.sensors=[],e.searchStr="",e.mobileDevice=t.innerWidth<992,angular.element(t).resize(function(){e.mobileDevice=t.innerWidth<992});var r="#f15c80",a="#90ed7d",i="#f7a35c",s="#7e09e8",l="#2150ff";e.alert={show:!1,message:""},e.chartConfig={xAxis:{type:"datetime"},yAxis:[{labels:{format:"{value}°C",style:{color:r,fontWeight:"bold"}},title:{text:"Temperature",style:{color:r,fontWeight:"bold"}},id:"temperature"},{labels:{format:"{value} lux",style:{color:i,fontWeight:"bold"}},title:{text:"Light",style:{color:i,fontWeight:"bold"}},id:"light"},{labels:{format:"{value}",style:{color:a,fontWeight:"bold"}},title:{text:"Pir",style:{color:a,fontWeight:"bold"}},id:"pir"},{labels:{format:"{value}%",style:{color:l,fontWeight:"bold"}},title:{text:"Humidity",style:{color:l,fontWeight:"bold"}},id:"humidity",opposite:!0},{labels:{format:"{value} ppm",style:{color:s,fontWeight:"bold"}},title:{text:"CO2",style:{color:s,fontWeight:"bold"}},id:"co2",opposite:!0}],series:[{name:" ",id:"placeholder-series"}],title:{text:"Data history"},noData:"Add sensors to drop area to see data chart"};var c,d,u,m;c=d=u=m=new Date,c.setDate(c.getDate()-1),d.setDate(d.getDate()-7),u.setMonth(u.getMonth()-1),m.setYear(m.getYear()-1),e.timeFrames=[{text:"Current",icon:"assets/shared/images/latest.svg",params:{newest:20}},{text:"Last Week",icon:"assets/shared/images/week.svg",params:{begin:d.toISOString()}},{text:"Last Month",icon:"assets/shared/images/month.svg",params:{begin:u.toISOString()}},{text:"Last Year",icon:"assets/shared/images/year.svg",params:{begin:m.toISOString()}},{text:"Select range",icon:"assets/shared/images/time-range.svg",params:{begin:null,end:null}}],e.timeFrame=e.timeFrames[0],e.selectTime=function(t){"Select range"===t.text?(e.modalInstance=o.open({templateUrl:"html/templates/select-range.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{timeFrame:t}}}}),e.modalInstance.result.then(function(t){var n=t.timeFrame.params;n.begin&&n.end&&(e.timeFrame=t.timeFrame,e.timeFrame.params.begin=n.begin.toISOString(),e.timeFrame.params.end=n.end.toISOString())})):e.timeFrame=t},e.clearSensors=function(){e.sensors=[],e.sensor=null,e.chartConfig.series=[{name:" ",data:[],legend:{enabled:!1},id:"placeholder-series"}]},e.addSensor=function(t){if(angular.isArray(t)){if(!t.length)return;return void angular.forEach(t,function(t){e.addSensor(t)})}for(var o=0;o<e.chartConfig.series.length;o++)if(e.chartConfig.series[o].id===t.id)return;var c={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:t.room},InfoItem:{"@name":t.name}}}},d=e.timeFrame.params;e.chartConfig.loading=!0,n.send("read",c,d).then(function(n){var o=n[0],c=[];e.sensor=t,e.sensors.push(t);for(var d=0;d<o.values.length;d++)c.push([new Date(o.values[d].time).getTime(),o.values[d].value]);e.chartConfig.series.length&&"placeholder-series"===e.chartConfig.series[0].id&&(e.chartConfig.series=[]);var u;switch(o.type){case"temperature":u=r;break;case"light":u=i;break;case"pir":u=a;break;case"humidity":u=l;break;case"co2":u=s;break;default:u="#707070"}e.chartConfig.series.push({name:o.room+": "+o.name,data:c,tooltip:{valueSuffix:" "+o.suffix},id:o.id,yAxis:o.type,color:u}),e.alert.show=!1,e.alert.message=""},function(t){e.alert.show=!0,e.alert.message=t})["finally"](function(){e.chartConfig.loading=!1})},e.dropSensor=function(e){}}]),angular.module("otaniemi3dApp").controller("PanoramaCtrl",["$scope","$state","$window","$modal","omiMessage","$q","$interval","buildingData",function(e,t,n,o,r,a,i,s){function l(){var e={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:f.roomId}}}};return r.send("read",e).then(function(e){return e})}function c(e){return d(e).then(u).then(m).then(p)}function d(e){for(var t={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:f.roomId},InfoItem:[]}}},n=0;n<e.length;n++)t.Object.Object.InfoItem.push({MetaData:{},"@name":e[n].type});return r.send("read",t).then(function(e){return f.sensors=e,f.sensors})}function u(e){var t=a.defer();return i(function(){$("#panorama_obj").length&&t.resolve(e)},150),t.promise}function m(e){return e.reduce(function(e,t){return e[t.metaData.ath+","+t.metaData.atv]||(e[t.metaData.ath+","+t.metaData.atv]=[]),e[t.metaData.ath+","+t.metaData.atv].push(t),e},{})}function p(e){var t=$("#panorama_obj")[0];return angular.forEach(e,function(e,n){var o=n.split(",");t.call("addsensor("+[e[0].id,o[0],o[1],h(e)].join(",")+',"'+JSON.stringify(e)+'")')}),e}function g(e){for(var t={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:f.roomId},InfoItem:[]}}},n=0;n<e.length;n++)t.Object.Object.InfoItem.push({MetaData:{InfoItem:[]},"@name":e[n].name}),angular.forEach(e[n].metaData,function(e,o){t.Objects.Object.Object.InfoItem[n].MetaData.InfoItem.push({"@name":o,value:{keyValue:e,"@type":"xs:double"}})});return r.send("write",t)}function h(e){var t="";e.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0});for(var n=0;n<e.length;n++){var o=e[n].values.length?e[n].values[0].value:"",r=e[n].suffix;r=r?" "+r:"",t+=["[tr]","[th]",e[n].name,"[/th]","[td]",o,r,"[/td]","[/tr]"].join("")}var a=['[table class="tooltip-table"]',"[tr]",'[th colspan="2" style="text-align:center"]',f.roomId,"[/th]","[/tr]",t,"[/table]"].join("");return a}var f=this;f.roomId=t.params.roomId,f.sensors=[],f.newSensors=[],f["class"]=e.App.fullscreen?"panorama-fullscreen":"";var v="https://otaniemi3d.cs.hut.fi/omi/node/Objects/K1/"+f.roomId,b="assets/buildings/"+s.currentBuilding.id+"/panorama/"+f.roomId+".xml";f.room={xmlPath:b,url:v,sensors:f.sensors},f.alert={show:!1,message:""},f.addSensors=function(e){f.newSensors=e},f.goBack=function(){n.history.back()},l().then(c),n.krpano={},n.krpano.addSensorDialog=function(){var t=$("#panorama_obj")[0],n=t.get("mouse.x"),r=t.get("mouse.y"),a=t.screentosphere(n,r);f.modalInstance=o.open({templateUrl:"html/templates/hotspot-selection.html",scope:e,controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{room:f.room,alert:f.alert,addSensors:f.addSensors}}}}),f.modalInstance.result.then(function(){if(f.newSensors.length){for(var e=0;e<f.newSensors.length;e++)f.newSensors[e].metaData={ath:a.x,atv:a.y};for(var n=0;n<f.newSensors.length;n++){for(var o=f.newSensors[n],r=!1,i=0;i<f.sensors.length;i++){var s=f.sensors[i];if(t.call("removehotspot("+s.id+")"),o.id===s.id){s.metaData=o.metaData,r=!0;break}}r||f.sensors.push(o)}var l=m(f.sensors);p(l),g(f.newSensors),f.newSensors=[]}})},e.$on("room-selection-change",function(n,o){o&&t.go("panorama",{building:e.App.building.id,roomId:o.id})}),e.$on("$destroy",function(){f.modalInstance&&f.modalInstance.dismiss()})}]),angular.module("otaniemi3dApp").controller("AppCtrl",["$scope","$state","buildingData",function(e,t,n){var o=this;o.navbarCollapse=!0,o.building=n.currentBuilding,o.allBuildings=n.buildings,o.room=null,o.rooms=[],o.floor=1,o.fullscreen=!1,o.navigation=[{state:"heat-map",name:"Heat Map"},{state:"x3dom",name:"3D Model"},{state:"analytics",name:"Analytics"}],o.showViewSelection=!1,o.resetPosition=function(){e.$broadcast("reset-position"),o.room=null},e.$on("$stateChangeSuccess",function(){"heat-map"!==t.current.name&&(o.fullscreen=!1),"google-maps"!==t.current.name?o.showViewSelection=!0:o.showViewSelection=!1}),e.$watch(function(){return n.currentBuilding},function(e,t){e!==t&&(o.building=e,o.building?o.rooms=o.building.rooms:o.rooms=[])}),e.$watch(function(){return o.room},function(t,n){t!==n&&(t?o.floor=t.floor:o.floor=1,e.$broadcast("room-selection-change",t))});var r=e.$watch(function(){return n.buildings},function(e){e&&(o.allBuildings=e,r())})}]),angular.module("otaniemi3dApp").controller("ModalCtrl",["$scope","$window","$modalInstance","params",function(e,t,n,o){function r(e){console.log(e)}var a=this;a.params=o,a.smallDevice=t.innerWidth<769,a.ok=function(){"function"==typeof a.params.validate?a.params.validate(a.params)?n.close(a.params):r(a.params.errorMsg):n.close(a.params)},a.cancel=function(){n.dismiss("cancel")}}]),angular.module("otaniemi3dApp").directive("heatMap",["valueConverter","$q","$rootScope","omiMessage",function(e,t,n,o){return{restrict:"E",scope:{floorplan:"=",selectedRoom:"=",sensorType:"=",building:"="},link:function(r,a){function i(e){var n=t.defer();return e.svg?n.resolve(e):d3.xml("assets/buildings/"+r.building.id+"/"+e.url,"image/svg+xml",function(t){t?(e.svg=t.documentElement,n.resolve(e)):n.reject("Error while fetching a floorplan")}),n.promise}function s(e){e.rooms=[],e.data=[],e.translate=[0,0],e.scale=1;var t=a[0].appendChild(e.svg);return t=d3.select(t).attr("width","100%").attr("height","100%").attr("pointer-events","all").attr("id","floorplan"),t.selectAll("path").each(function(){var e=d3.select(this);e.attr("data-room-id")||e.attr("pointer-events","none")}),t.selectAll("text").attr("pointer-events","none"),g=d3.behavior.zoom().scaleExtent([.5,10]).scale(e.scale).translate(e.translate).on("zoom",function(){t.select("g").attr("transform",["translate(",d3.event.translate,")","scale(",d3.event.scale,")"].join("")),e.scale=d3.event.scale,e.translate=d3.event.translate}),t.call(g),n.$broadcast("floorplan-loaded"),h=!0,p(r.selectedRoom),e}function l(e){var t={Object:{id:{keyValue:"K1"},Object:[]}};return d3.select(e.svg).selectAll("[data-room-id]").each(function(){t.Object.Object.push({id:{keyValue:d3.select(this).attr("data-room-id")}})}),o.send("read",t).then(function(t){return e.data=t,e},function(){return e.data=e.data||[],e})}function c(e){return d3.select(e.svg).selectAll("[data-room-id]").datum(function(){var t=d3.select(this).datum();if(t&&t.sensors.length)return t;for(var n,o={sensors:[]},r=d3.select(this).attr("data-room-id"),a=0;a<e.data.length;a++){var i=e.data[a];i.roomId===r&&(o.sensors.push(i),n=i.room)}return o.room=n?n:r,o.roomId=r,e.rooms.push({name:o.room,id:o.roomId}),o}),e}function d(t){d3.select(t.svg).selectAll("[data-room-id]").each(function(){for(var t=d3.select(this).datum(),n=0;n<t.sensors.length;n++)if(t.sensors[n].type===r.sensorType.name){var o=t.sensors[n],a=o.values[0].value,i=e.getColor(o.type,a);d3.select(this).style("fill",i.rgb).style("fill-opacity",i.opacity)}})}function u(e){var t=d3.select(r.floorplan.svg),n=t.node().getBoundingClientRect(),o=[n.width/2,n.height/2],a=e.node(),i=a.getBBox(),s=i.x+i.width/2,l=i.y+i.height/2,c=1.6,d=[o[0]-s*c,o[1]-l*c];m(c,d)}function m(e,t,n){n=n||1e3,g&&(r.floorplan.translate=t,r.floorplan.scale=e,d3.select(r.floorplan.svg).transition().duration(n).call(g.translate(t).scale(e).event))}function p(e){d3.select(r.floorplan.svg).selectAll("[data-room-id]").each(function(){var t=d3.select(this);t.style("stroke-width",null).style("stroke",null).style("stroke-opacity",null),t.attr("data-room-id")===e.id&&(t.style("stroke-width","15").style("stroke","#ffcc00").style("stroke-opacity","0").transition().ease("cubic-in-out").style("stroke-opacity","1"),u(t))})}var g,h=!1;i(r.floorplan).then(s).then(l).then(c).then(d),r.$on("reset-position",function(){m(1,[0,0])}),r.$watch("selectedRoom",p),r.$watch("sensorType",function(){h&&d(r.floorplan)})}}}]),angular.module("otaniemi3dApp").directive("tooltip",["$state","valueConverter",function(e,t){return{restrict:"E",template:['<table class="tooltip-table">',"<tr>",'<th colspan="2" style="text-align:center">{{tooltip.room}}</th>',"</tr>","<tr ng-repeat=\"sensor in tooltip.sensors | orderBy: 'name'\"","ng-style=\"{'background-color': sensor.color}\">","<th>{{sensor.name}}</th>","<td>{{sensor.values[0].value}} {{sensor.suffix}}</td>","</tr>","<tr>",'<td colspan="2">','<button ng-click="tooltip.openPanorama(tooltip.roomId)"','ng-show="tooltip.hasPanorama"','class="btn black-btn panorama-btn">',"360°",'<span class="glyphicon glyphicon glyphicon-camera"></span>',"</button>",'<i class="tooltip-caption">{{tooltip.caption}}',"</i>","</td>","</tr>","</table>"].join(""),scope:{sensorType:"="},controller:function(){this.sensors=[],this.room="",this.roomId="",this.caption="Downloading sensor data...",this.isLocked=!1,this.roomsWithPanorama=["Room-238d","Room-237c","Room-235","Room-232a","2nd Floor Corridor Start","2nd Floor Corridor Middle","2nd Floor Corridor End","Corridor Cafeteria Side","Corridor Entrance Side","Cafeteria","Entrance"],this.hasPanorama=!1,this.openPanorama=function(t){e.go("panorama",{roomId:t})}},controllerAs:"tooltip",bindToController:!0,link:function(e,n,o,r){function a(){d3.select(n[0]).style("display",null)}function i(o){r.isLocked||(a(),o&&(r.caption="Click to lock the tooltip",e.$apply(function(){if(r.sensors=[],r.room="",o.sensors.length)for(var e=0;e<o.sensors.length;e++){var n=o.sensors[e],a=n.values[0].value,i={};n.type===r.sensorType.name?i=t.getColor(n.type,a):i.rgbaString="",n.color=i.rgbaString,r.sensors.push(n)}o.room&&(r.room=o.room),o.roomId&&(r.roomId=o.roomId,r.roomsWithPanorama.indexOf(o.roomId)>-1?r.hasPanorama=!0:r.hasPanorama=!1)})),d3.event.pageY>window.innerHeight/2?d3.select(n[0]).style("bottom",window.innerHeight-d3.event.pageY+"px").style("top","auto"):d3.select(n[0]).style("top",d3.event.pageY-10+"px").style("bottom","auto"),d3.select(n[0]).style("left",d3.event.pageX+"px").style("right","auto"))}function s(){r.isLocked||d3.select(n[0]).style("display","none")}function l(){r.isLocked=!1,i(),r.isLocked=!0,d3.event.preventDefault()}function c(){d3.event.defaultPrevented||(r.isLocked=!1,s())}d3.select(n[0]).style("display","none"),d3.select(n.parent()[0]).selectAll("[data-room-id]").on("mouseover",a).on("mousemove",i).on("mouseout",s).on("mouseup",l),d3.select(n.parent()[0]).select("#floorplan").on("mousedown.tooltip",c),e.$on("$destroy",function(){d3.select(n.parent()[0]).selectAll("[data-room-id]").on("mouseover",null).on("mousemove",null).on("mouseout",null).on("click",null)})}}}]),angular.module("otaniemi3dApp").directive("sensorTree",["$document","$http","omiMessage",function(e,t,n){return{template:"<div></div>",restrict:"E",scope:{selectSensor:"=",dragSensor:"=",search:"=",checkbox:"=",rootUrl:"=",error:"="},link:function(o,r,a){function i(e,t){return t?s.get_node(e).original:s.get_node(e)}r.jstree({plugins:["sort",o.checkbox?"checkbox":"","string"==typeof a.search?"search":"","string"==typeof a.dragSensor?"dnd":""],search:{show_only_matches:!0,show_only_matches_children:!0},dnd:{is_draggable:function(e){var t=e[0];return"sensor"===t.original.type}},core:{check_callback:!0,worker:!1,data:function(e,r){function a(e,t,n){t.call(e,n),o.error.show=!1,o.error.message=""}function i(e,t,n){t.call(e,n.errorNode),o.error.show=!0,o.error.message=n.errorMsg}var s,l,c,d=[],u={errorNode:[{text:"Error"}],errorMsg:"Error when opening a tree node. Please close and reopen the node to try again."},m=o.rootUrl.split("/");"#"===e.id?(m=m[m.length-1].length?m[m.length-1]:m[m.length-2],"K1"===m?(s="assets/shared/images/icon-building.svg",l="building"):(s="assets/shared/images/icon-room.svg",l="room"),d=[{id:m,text:m.split("-").join(" "),children:!0,type:l,icon:s,state:{opened:!0}}],r.call(this,d)):"sensor"===e.original.type?t.get(e.original.url).success(function(e){var t=n.parseInfoItem(e);t.length&&(d=[{values:t,text:t[0].value+"  --  "+t[0].time.toISOString(),icon:!1,type:"value"}]),a(this,r,d)}).error(function(){i(this,r,u)}):"room"===e.original.type?(c=o.rootUrl,"#"!==e.parent&&(c+=e.id),t.get(c).success(function(t){for(var o=n.parseObject(t),i=0;i<o.infoItems.length;i++){var s=o.infoItems[i];d.push({id:s+"-"+e.id,room:o.id,name:s,text:s.charAt(0).toUpperCase()+s.slice(1),children:!0,icon:"assets/shared/images/icon-"+s+".svg",type:"sensor",url:c+"/"+s})}a(this,r,d)}).error(function(){i(this,r,u)})):"building"===e.original.type&&(c=o.rootUrl,"#"!==e.parent&&(c+=e.id),t.get(c).success(function(e){for(var t=n.parseObject(e),i=0;i<t.objects.length;i++){var s=t.objects[i];d.push({id:s,text:s.split("-").join(" "),children:!0,icon:"assets/shared/images/icon-room.svg",type:"room",url:o.rootUrl+s})}a(this,r,d)}).error(function(){i(this,r,u),e.children=!0}))},themes:{responsive:!0}}});var s=r.jstree(!0);r.on("after_close.jstree",function(e,t){t.node.children=!0,i(t.node.id).state.loaded=!1}).on("select_node.jstree",function(){if("string"==typeof a.selectSensor){var e=[];angular.forEach(s.get_selected(!0),function(t){"sensor"===t.original.type&&e.push(t.original)}),o.selectSensor(e)}}),e.on("dnd_stop.vakata",function(e,t){var n=$(t.event.target);if(n.closest("#drop-area").length){var r=i(t.data.nodes[0],!0);o.dragSensor(r)}}).on("dnd_move.vakata",function(e,t){var n=$(t.event.target);n.closest(r).length||(n.closest("#drop-area").length?t.helper.find(".jstree-icon").removeClass("jstree-er").addClass("jstree-ok"):t.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er"))}),"string"==typeof o.search&&o.$watch("search",function(e){e?s.search(e):s.clear_search()}),o.$on("$destroy",function(){$.jstree.destroy(),e.off("dnd_stop.vakata dnd_move.vakata")})}}}]),angular.module("otaniemi3dApp").directive("panorama",function(){return{restrict:"E",scope:{room:"="},link:function(e){embedpano({xml:e.room.xmlPath,id:"panorama_obj",target:"room-panorama",html5:"only",passQueryParameters:!0,consolelog:!0,debugmode:!0,initvars:{krpanodir:"../../../krpano"}}),e.$on("$destroy",function(){removepano("panorama_obj")})}}}),angular.module("otaniemi3dApp").directive("legendbar",["valueConverter",function(e){return{restrict:"E",template:['<p id="legendMinText" class="legendText"></p>','<svg id="legendContainingSvg">',"<g>","<defs>",'<lineargradient id="legendGradient"','x1="0%" x2="0%" y1="0%" y2="100%">',"<stop></stop>","</lineargradient>","</defs>","</g>",'<rect id="gradient-rect"','class="legend-rect"','fill="url(#legendGradient)"','rx="10" ry="10"',"ng-show=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<rect id="binary-rectTop"','class="binary-rect legend-rect"','rx="10" ry="10"',"ng-hide=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<rect id="binary-rect-bottom"','class="binary-rect legend-rect"','rx="10" ry="10"',"ng-hide=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<line id="legendLine"></line>','<text id="legendLineText"></text>',"</svg>",'<p id="legendMaxText" class="legendText"></p>'].join(""),scope:{sensorType:"="},controller:function(){},controllerAs:"legendbar",link:function(t){function n(){s.style("visibility","visible"),l.style("visibility","visible")}function o(){s.style("visibility","hidden"),l.style("visibility","hidden")}function r(){var n=[0,0],o=d3.select("#gradient-rect").node();n=d3.mouse(o);var r=o.getBBox().height,a=(n[1]-m)/r,i=e.valueAtPercent(t.sensorType.name,a)+e.getValueUnit(t.sensorType.name),c=Math.min(r-3,Math.max(n[1],7));s.attr("y1",c).attr("y2",c),l.attr("y",c+3).text(i)}function a(){d3.select("#legendMinText").style("margin","0px").text(e.temperatureMin+e.getValueUnit(t.sensorType.name)),d3.select("#legendContainingSvg").attr("width",d).attr("height","100%"),d3.select("#legendMaxText").text(e.temperatureMax+e.getValueUnit(t.sensorType.name)),d3.select("#gradient-rect").attr("x",u).attr("y",m).attr("width",c).attr("height","99%"),s=d3.select("#legendLine").attr("x1",u).attr("y1",m).attr("x2",u+c).attr("y2",m).attr("stroke","black").attr("stroke-width",1).style("visibility","hidden"),l=d3.select("#legendLineText").attr("x",u+c).attr("y",m).style("visibility","hidden").text(""),d3.select("#gradient-rect").on("mouseover",n).on("mousemove",r).on("mouseout",o);for(var a,i,p,g,h=160,f=0,v=.3,b=1,y=35,x=1/(y-1),w=(f-h)/(y-1),$=(b-v)/(y-1),M=[],k=0;y>k;k++)a=h+w*k,i=d3.hsl(a,1,.6).toString(),p=v+$*k,g=0+x*k,M.push({rgb:i,opacity:p,percent:g});var S=d3.select("#legendGradient").selectAll("stop").data(M);S.enter().append("stop"),S.attr("offset",function(e){return e.percent}).attr("stop-color",function(e){return e.rgb}).attr("stop-opacity",function(e){return e.opacity});var C=e.getColor("occupancy",0),I=e.getColor("occupancy",1);d3.select("#binary-rectTop").attr("x",u).attr("y",m).attr("width",c).attr("height","50%").attr("fill",C.rgb).attr("fill-opacity",C.opacity),d3.select("#binary-rect-bottom").attr("x",u).attr("y","50%").attr("width",c).attr("height","50%").attr("fill",I.rgb).attr("fill-opacity",I.opacity)}function i(t){var n,o;switch(t){case"temperature":n=e.temperatureMin,o=e.temperatureMax;break;case"humidity":n=e.humidityMin,o=e.humidityMax;break;case"co2":n=e.co2Min,o=e.co2Max;break;case"pir":n=e.occupancyMin,o=e.occupancyMax;break;case"light":n=e.lightMin,o=e.lightMax;break;case"pir":n=e.occupancyMin,o=e.occupancyMax}n+=e.getValueUnit(t),o+=e.getValueUnit(t),d3.select("#legendMinText").text(n),d3.select("#legendMaxText").text(o)}var s,l,c=20,d=80,u=0,m=1;a(),t.$watch("sensorType.name",function(e){
e&&i(e)})}}}]),angular.module("otaniemi3dApp").directive("dateRange",function(){return{restrict:"EA",scope:{ngModel:"=",current:"="},link:function(e,t){var n=e.ngModel;n&&(n.begin=null,n.end=null),t.dateRangePicker({inline:!0,container:t,alwaysOpen:!0,singleMonth:!0,showShortcuts:!1,startOfWeek:"monday"}).bind("datepicker-change",function(e,t){n&&(n.begin=t.date1,n.end=t.date2)}),t.find(".footer").remove(),e.$watch("current",function(e){if(e){var n=e.begin||(new Date).toISOString(),o=e.end||(new Date).toISOString();n=n.split("T")[0],o=o.split("T")[0],console.log(e.begin),console.log(o),t.data("dateRangePicker").setDateRange(n,o)}}),e.$on("destroy",function(){t.data("dateRangePicker").destroy()})}}}),angular.module("otaniemi3dApp").service("valueConverter",function(){var e=this;this.temperatureMin=15,this.temperatureMax=35,this.co2Min=350,this.co2Max=5e3,this.lightMin=30,this.lightMax=1e4,this.pirMin=0,this.pirMax=30,this.humidityMin=30,this.humidityMax=70,this.occupancyMin="no",this.occupancyMax="yes",this.getColor=function(t,n){var o,r,a=t.toLowerCase();switch(a){case"temperature":o=e.temperatureMin,r=e.temperatureMax;break;case"co2":o=e.co2Min,r=e.co2Max;break;case"light":o=e.lightMin,r=e.lightMax;break;case"pir":o=e.pirMin,r=e.pirMax;break;case"humidity":o=e.humidityMin,r=e.humidityMax}var i;"occupancy"===a||"pir"===a||"occupied"===a?i=0>=n?0:1:(i=Math.min((n-o)/(r-o),1),i=Math.max(i,0));var s,l,c,d,u=160,m=0,p=.3,g=1;s=u+i*(m-u),l=d3.hsl(s,1,.6).toString(),c=p+i*(g-p);var h=d3.hsl(s,1,.6).rgb();return d="rgba("+h.r+","+h.g+","+h.b+","+c+")",{rgb:l,opacity:c,rgbaString:d}},this.valueAtPercent=function(t,n){var o,r;switch(t){case"temperature":o=e.temperatureMin,r=e.temperatureMax;break;case"co2":o=e.co2Min,r=e.co2Max;break;case"light":o=e.lightMin,r=e.lightMax;break;case"pir":return.5>=n?"no":"yes";case"humidity":o=e.humidityMin,r=e.humidityMax;break;case"occupancy":return.5>=n?"no":"yes"}var a=(o+n*(r-o))/1;return 0>a?Math.ceil(a):Math.floor(a)},this.getValueUnit=function(e){switch(e){case"temperature":return"°C";case"co2":return"ppm";case"light":return"lux";case"humidity":return"%";default:return""}}}),angular.module("otaniemi3dApp").service("omiMessage",["$http","$q","$interval","dataStorage","JXON",function(e,t,n,o,r){function a(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=l(e,'//*[local-name()="Object"]');0===t.length&&console.log("Couldn't fetch any sensor data from the server.");for(var n=[],o=0;o<t.length;o++){var r=t[o].getElementsByTagName("id");if(r.length>0){r=r[0].textContent;for(var a=t[o].children,i=0;i<a.length;i++)if("InfoItem"===a[i].tagName){for(var c,u=a[i].getAttribute("name"),m=a[i].children,p=[],g={},h=0;h<m.length;h++)if("value"===m[h].tagName){var f,v=m[h].textContent,b=m[h].getAttribute("unixTime"),y=m[h].getAttribute("dateTime");v&&(v=Math.round(100*Number(v))/100),f=y?new Date(y).getTime():new Date(1e3*Number(b)),!isNaN(v)&&f&&p.push({value:v,time:f})}else"MetaData"===m[h].tagName&&(c=m[h]);if(c){var x=document.createElement("div");x.appendChild(c),g=d.parseMetaData(x.innerHTML)}if(u){s(p);var w;switch(u.toLowerCase()){case"co2":w="CO2";break;case"pir":w="Occupancy";break;default:w=u.charAt(0).toUpperCase()+u.slice(1)}var $;switch(u.toLowerCase()){case"temperature":$="°C";break;case"co2":$="ppm";break;case"light":$="lux";break;case"humidity":$="%";break;case"pir":$="";break;default:$=""}n.push({id:u+"-"+r,type:u,room:r.split("-").join(" "),roomId:r,name:w,values:p,suffix:$,metaData:g})}}}}return n}function i(e,t,n){var o={"omi:omiEnvelope":{"@xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","@xmlns:omi":"omi.xsd","@version":"1.0","@ttl":"0"}},a=o["omi:omiEnvelope"]["omi:"+t]={"@msgformat":"odf","omi:msg":!0};angular.forEach(n,function(e,t){a["@"+t]=e});var i=r.createXML(o),s=document.createElementNS("odf.xsd","Objects");s=s.appendJXON(e),$(i.documentElement).find("omi\\:msg").append(s);var l=i.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"');return i.insertBefore(l,i.firstChild),(new XMLSerializer).serializeToString(i)}function s(e){e.sort(function(e,t){return e.time-t.time})}function l(e,t){for(var n=new XPathEvaluator,o=n.createNSResolver(null===e.ownerDocument?e.documentElement:e.ownerDocument.documentElement),r=n.evaluate(t,e,o,0,null),a=[],i=r.iterateNext();i;)a.push(i),i=r.iterateNext();return a}var c={},d=this;this.send=function(n,r,s,l,d){var u=t.defer(),m="https://otaniemi3d.cs.hut.fi/omi/node/";s=s||{},l=l||"",d=d||!0;var p=i(r,n,s);return c[p]?u.reject():(c[p]=!0,e.post(m,p,{headers:{"Content-Type":"application/xml"},ignoreLoadingBar:!d}).then(function(e){var t=a(e.data);u.resolve(t),o.sensors=t},function(e){var t;404===e.status?(t="Couldn't find such sensors or values.",console.log(t),u.reject(t)):(t="Failed to fetch sensor data. Please try again",console.log(t),u.reject(t))})["finally"](function(){c[p]=!1})),u.promise},d.parseInfoItem=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=[];return $(e).find("value").each(function(){var e=$(this).attr("unixTime");e?e=new Date(1e3*Number(e)):(e=$(this).attr("dateTime"),e=new Date(e));var n=$(this).text();n&&(n=Math.round(100*Number(n))/100),t.push({value:n,time:e})}),t},this.parseMetaData=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t={};return $(e).find("InfoItem").each(function(){t[$(this).attr("name")]=$(this).find("value").text()}),t},this.parseObject=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=$(e).find(":root"),n=t.children("id").first().text(),o=[],r=[];return t.children("Object").each(function(){o.push($(this).children("id").text())}),t.children("InfoItem").each(function(){r.push($(this).attr("name"))}),{id:n,text:n.split("-").join(" "),infoItems:r,objects:o}}}]),angular.module("otaniemi3dApp").service("dataStorage",function(){var e=this;e.sensors=[]}),angular.module("otaniemi3dApp").service("JXON",function(){function e(r,a,i){var s,l,c=a.namespaceURI;if(i.constructor===String||i.constructor===Number||i.constructor===Boolean){if(a.appendChild(r.createTextNode(i.toString())),i===i.valueOf())return}else i.constructor===Date&&a.appendChild(r.createTextNode(i.toGMTString()));for(var d in i)if(s=i[d],!(isFinite(d)||s instanceof Function))if(d===t)null!==s&&s!==!0&&a.appendChild(r.createTextNode(s.constructor===Date?s.toGMTString():String(s)));else if(d===n)for(var u in s)a.setAttribute(u,s[u]);else if(d.charAt(0)===o)a.setAttribute(d.slice(1),s);else if(s.constructor===Array)for(var m=0;m<s.length;m++)l=c?r.createElementNS(c,d):r.createElement(d),e(r,l,s[m]),a.appendChild(l);else l=c?r.createElementNS(c,d):r.createElement(d),s instanceof Object?e(r,l,s):null!==s&&s!==!0&&l.appendChild(r.createTextNode(s.toString())),a.appendChild(l)}var t="keyValue",n="keyAttributes",o="@";Element.prototype.appendJXON=function(t){var n=document.createElementNS(this.namespaceURI,this.nodeName);return e(document,n,t),this.parentNode&&this.parentNode.replaceChild(n,this),n},this.createXML=function(t,n,o,r){var a=document.implementation.createDocument(n||null,o||"",r||null);return o?e(a,a.documentElement,t):e(a,a,t),a}}),angular.module("otaniemi3dApp").service("buildingData",function(){var e=this;e.buildings=null,e.currentBuilding=null});