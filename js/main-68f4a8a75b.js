"use strict";angular.module("otaniemi3dApp",["ui.bootstrap","ui.grid","ui.router","ui.event","angular-loading-bar","highcharts-ng"]).config(["$stateProvider","$urlRouterProvider","$urlMatcherFactoryProvider",function(e,t,n){function o(e,t,n,o){var r=o.defer();return a(t,o,n).then(function(t){for(var o,a=0;a<t.length;a++)if(t[a].id===e.building){o=t[a];break}o?(n.currentBuilding=o,r.resolve(o)):r.reject("Selected building is not in the database")}),r.promise}function a(e,t,n){var o=t.defer();return n.buildings?o.resolve(n.buildings):e.get("assets/buildings/buildings.json").then(function(e){n.buildings=e.data,o.resolve(e.data)}),o.promise}o.$inject=["$stateParams","$http","buildingData","$q"],a.$inject=["$http","$q","buildingData"],n.strictMode(!1),t.when("",["$state",function(e){e.go("google-maps")}]).when("/google-maps",["$state",function(e){e.go("google-maps")}]).otherwise("not-found"),e.state("google-maps",{url:"/:building",templateUrl:"html/views/google-maps.html",controller:"GoogleMapsCtrl as googleMaps",resolve:{buildings:a}}).state("building",{"abstract":!0,url:"/:building",template:"<ui-view/>",resolve:{currentBuilding:o}}).state("sensor-list",{url:"/sensor-list",templateUrl:"html/views/sensor-list.html",controller:"SensorListCtrl as sensorlist",parent:"building"}).state("heat-map",{url:"/heat-map/:floor/:room",templateUrl:"html/views/heat-map.html",controller:"HeatMapCtrl as heatmap",parent:"building",resolve:{floor:["$stateParams","buildingData","$q","$http",function(e,t,n,o){var r=n.defer(),i=Number(e.floor),s=!1;return a(o,n,t).then(function(){for(var e=t.currentBuilding.floorplans,n=0;n<e.length;n++)if(e[n].floor===i){s=!0;break}s?r.resolve(i):r.reject("Selected building is not in database")}),r.promise}]}}).state("x3dom",{url:"/x3dom/:roomId",templateUrl:"html/views/x3dom.html",controller:"X3DomCtrl as x3dom",parent:"building",params:{roomId:{value:null,squash:!0}}}).state("analytics",{url:"/analytics",templateUrl:"html/views/analytics.html",controller:"AnalyticsCtrl as analytics",parent:"building"}).state("panorama",{url:"/panorama/:roomId",templateUrl:"html/views/panorama.html",controller:"PanoramaCtrl as panorama",parent:"building"}).state("not-found",{url:"{path:.*}",templateUrl:"html/views/not-found.html"})}]).config(["cfpLoadingBarProvider",function(e){e.includeSpinner=!1}]).run(["$rootScope","$state",function(e,t){String.prototype.endsWith||(String.prototype.endsWith=function(e,t){var n=this.toString();(void 0===t||t>n.length)&&(t=n.length),t-=e.length;var o=n.indexOf(e,t);return-1!==o&&o===t}),FastClick.attach(document.body);var n=!1;e.$on("$stateChangeError",function(e){t.go("not-found"),n=!0,e.preventDefault()}),e.$on("$locationChangeStart",function(e,t){n&&t.endsWith("/#/")&&(n=!1,e.preventDefault())})}]),angular.module("otaniemi3dApp").controller("GoogleMapsCtrl",["$scope","$timeout","buildingData","$state","$compile",function(e,t,n,o,a){function r(e){for(var t=new google.maps.LatLngBounds,n=0;n<e.coords.length;n++){var o=e.coords[n];t.extend(new google.maps.LatLng(o.lat,o.lng))}return t.getCenter()}function i(t,o){angular.forEach(o,function(a){var r=new google.maps.Polygon({paths:a.coords,strokeColor:f,strokeOpacity:.8,strokeWeight:2,fillColor:h,fillOpacity:.35});r.setMap(t),a.polygon=r,n.currentBuilding&&n.currentBuilding.id===a.id&&r.setOptions({fillColor:f}),google.maps.event.addListener(r,"click",function(){e.$apply(function(){r.setOptions({fillColor:f}),n.currentBuilding=a,angular.forEach(o,function(e){r!==e.polygon&&e.polygon.setOptions({fillColor:h})})})}),google.maps.event.addListener(r,"mouseover",function(){e.$apply(function(){r.setOptions({strokeWeight:4})})}),google.maps.event.addListener(r,"mouseout",function(){e.$apply(function(){r.setOptions({strokeWeight:2})})})}),google.maps.event.addListener(t,"click",function(){e.$apply(function(){angular.forEach(o,function(e){e.polygon.setOptions({fillColor:h})}),m.close(),n.currentBuilding=null})}),google.maps.event.addListener(m,"closeclick",function(){e.$apply(function(){angular.forEach(o,function(e){e.polygon.setOptions({fillColor:h})}),n.currentBuilding=null})})}var s={lat:60.1866142,lng:24.830513},l=16,c={zoom:l,center:s,mapTypeId:google.maps.MapTypeId.TERRAIN,mapTypeControl:!0,mapTypeControlOptions:{position:google.maps.ControlPosition.LEFT_BOTTOM}},d=new google.maps.Map($("#google-map")[0],c),u=o.params.building,m=new google.maps.InfoWindow({content:a(['<div class="info-window">',"<h4>","{{App.building.name}}","</h4>","<ul>",'<li ng-repeat="nav in App.navigation track by nav.state">','<a class="btn btn-default"','ui-sref="{{nav.state}}({building: App.building.id,',"floor: App.building.floorplans[0].floor,",'room: App.room.id})">',"{{nav.name}}","</a>","</li>","</ul>","</div>"].join(""))(e)[0]});if(u&&u.length){for(var p,g=0;g<n.buildings.length;g++)if(n.buildings[g].id===u){p=n.buildings[g];break}if(!p)return n.currentBuilding=null,void o.go("not-found");n.currentBuilding=p,m.setPosition(r(p)),m.open(d)}var f="#FF0000",h="#808080";t(function(){i(d,n.buildings);var e=d.getCenter();google.maps.event.trigger(d,"resize"),d.setCenter(e)}),e.$watch("App.building",function(e,t){o.transition||e===t||(e?(m.setPosition(r(e)),m.open(d),o.go("google-maps",{building:e.id},{notify:!1,location:"replace"})):o.go("google-maps",{building:""},{notify:!1,location:"replace"}))}),e.$on("reset-position",function(){d.setCenter(s),d.setZoom(l)}),e.$on("room-selection-change",function(t,n){n&&o.go("heat-map",{building:e.App.building.id,floor:n.floor,room:n.id})}),e.$on("destroy",function(){e.$apply(function(){angular.forEach(n.buildings,function(e){google.maps.event.removeInstanceListeners(e.polygon)}),google.maps.event.clearListeners(d,"click"),google.maps.event.clearListeners(m,"closeclick"),m.close()})})}]),angular.module("otaniemi3dApp").controller("HeatMapCtrl",["$scope","buildingData","$modal","$state",function(e,t,n,o){function a(t){e.room=t}function r(e){for(var n=t.currentBuilding.rooms,o=0;o<n.length;o++)if(n[o].id===e)return n[o]}var i=this;e.floor=Number(o.params.floor),e.currentBuilding=t.currentBuilding,e.App.statistics=!0;for(var s=!1,l=0;l<e.currentBuilding.floorplans.length;l++){var c=e.currentBuilding.floorplans[l];if(c.floor===e.floor){s=!0;break}}if(!s)return o.go("not-found"),void(e.floor=1);e.room={},o.params.room&&(e.App.room=r(o.params.room),a(e.App.room)),e.searchString="",e.floorplans=e.currentBuilding.floorplans,e.svgSupport=Modernizr.svg,i.isFloorplanLoaded=!1,e.floorplan=e.floorplans[e.floor-1],e.sensorTypes=[{text:"Temperature",name:"temperature",icon:"assets/shared/images/temperature.svg"},{text:"CO2",name:"co2",icon:"assets/shared/images/co2.svg"},{text:"Humidity",name:"humidity",icon:"assets/shared/images/humidity.svg"},{text:"Light",name:"light",icon:"assets/shared/images/light.svg"},{text:"Occupancy",name:"pir",icon:"assets/shared/images/pir.svg"}];var d=new Date,u=new Date,m=new Date,p=new Date;d.setDate(d.getDate()-1),u.setDate(u.getDate()-7),m.setMonth(m.getMonth()-1),p.setFullYear(p.getFullYear()-1),e.timeFrames=[{text:"Current",icon:"assets/shared/images/latest.svg",params:{}},{text:"Last Week",icon:"assets/shared/images/week.svg",params:{begin:u.toISOString()}},{text:"Last Month",icon:"assets/shared/images/month.svg",params:{begin:m.toISOString()}},{text:"Last Year",icon:"assets/shared/images/year.svg",params:{begin:p.toISOString()}},{text:"Select range",icon:"assets/shared/images/time-range.svg",params:{begin:null,end:null}}],e.sensorType=e.sensorTypes[0],e.timeFrame=e.timeFrames[0],e.selectSensorType=function(t){e.sensorType=t},e.selectTimeFrame=function(t){"Select range"===t.text?(e.modalInstance=n.open({templateUrl:"html/templates/select-range.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{timeRange:{begin:null,end:null}}}}}),e.modalInstance.result.then(function(n){var o=n.timeRange;o.begin&&o.end&&(t.params.begin=o.begin.toISOString(),t.params.end=o.end.toISOString(),e.App.timeFrame=e.timeFrame=t)})):e.App.timeFrame=e.timeFrame=t},e.toggleFullscreen=function(){e.App.fullscreen=!e.App.fullscreen},e.nextFloor=function(){o.go("heat-map",{floor:e.floor+1})},e.prevFloor=function(){o.go("heat-map",{floor:e.floor-1})},e.App.showOptions=function(){e.App.sensorTypes=e.sensorTypes,e.App.sensorType=e.sensorType,e.App.timeFrames=e.timeFrames,e.App.timeFrame=e.timeFrame,e.App.selectOptions=function(t,n){e.sensorType=e.App.sensorType=t,e.selectTimeFrame(n)}},e.mobileModal=function(){i.modalInstance=n.open({templateUrl:"html/templates/sensor-options.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{sensorTypes:e.sensorTypes,sensorType:e.sensorType,timeFrames:e.timeFrames,timeFrame:e.timeFrame,timeRange:{begin:null,end:null}}}}}),i.modalInstance.result.then(function(t){var n=t.timeRange;if(n.begin&&n.end){var o=e.timeFrames.length,a=e.timeFrames[o-1];a.params.begin=n.begin.toISOString(),a.params.end=n.end.toISOString(),e.timeFrame=a}else e.timeFrame=t.timeFrame;e.sensorType=t.sensorType})},e.$on("room-selection-change",function(t,n){n?o.go("heat-map",{building:e.App.building.id,floor:n.floor,room:n.id}):o.go("heat-map",{building:e.App.building.id,floor:e.floor,room:null},{location:"replace",notify:!1})}),e.$on("floorplan-loaded",function(){i.isFloorplanLoaded=!0}),e.$on("$destroy",function(){i.modalInstance&&i.modalInstance.dismiss(),e.App.statistics=!1})}]),angular.module("otaniemi3dApp").controller("SensorListCtrl",["$scope","dataStorage","omiMessage",function(e,t,n){e.gridOptions={enableFiltering:!0,data:t.sensors,columnDefs:[{field:"room"},{field:"name",name:"type"},{field:"values[0].value",name:"value"},{field:"values[0].time.toISOString()",name:"time"}]};var o={Object:{id:{keyValue:"K1"}}};n.send("read",o).then(function(t){e.gridOptions.data=t})}]),angular.module("otaniemi3dApp").controller("X3DomCtrl",["$scope","$modal","$state","$q","$interval","$timeout","$window","omiMessage",function(e,t,n,o,a,r,i,s){function l(){var e=o.defer();return a(function(){i.x3domReady&&e.resolve(!0)},100),r(function(){i.x3domReady||e.reject("Request timed out. Couldn't download x3dom files in 8.0 seconds.")},8e3),e.promise}function c(e){var t={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:e}}}};return s.send("read",t).then(function(e){return e})}e.panoramabox="assets/shared/images/panoramabox.svg",e.selected=void 0,e.webglSupport=Modernizr.webgl,e.building=n.params.building,e.changeView=function(e){var t=$("#3dModel__"+e);return t.length?(t.attr("set_bind","true"),!0):!1},l().then(function(){if(n.params.roomId)for(var t=0;t<e.App.rooms.length;t++)if(n.params.roomId===e.App.rooms[t].id){var o=e.changeView(n.params.roomId);o&&(e.App.room=e.App.rooms[t]);break}}),e.panoramaViewer=function(e){n.go("panorama",{roomId:e})},e.modalTooltip=function(n){e.modalInstance=t.open({templateUrl:"html/templates/sensor-info.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return c(n)}}})},e.$on("reset-position",function(){n.go("x3dom",{building:e.building,roomId:null},{location:"replace",notify:!1}),e.changeView("vp0")}),e.$on("room-selection-change",function(t,o){o&&(n.go("x3dom",{building:e.building,roomId:o.id},{location:"replace",notify:!1}),e.changeView(o.id))}),e.$on("$destroy",function(){e.modalInstance&&e.modalInstance.dismiss()})}]),angular.module("otaniemi3dApp").controller("AnalyticsCtrl",["$scope","$window","omiMessage","$modal",function(e,t,n,o){e.sensor=null,e.sensors=[],e.searchStr="",e.mobileDevice=t.innerWidth<992,angular.element(t).resize(function(){e.mobileDevice=t.innerWidth<992});var a="#f15c80",r="#90ed7d",i="#f7a35c",s="#7e09e8",l="#2150ff";e.alert={show:!1,message:""},e.chartConfig={xAxis:{type:"datetime"},yAxis:[{labels:{format:"{value}°C",style:{color:a,fontWeight:"bold"}},title:{text:"Temperature",style:{color:a,fontWeight:"bold"}},id:"temperature"},{labels:{format:"{value} lux",style:{color:i,fontWeight:"bold"}},title:{text:"Light",style:{color:i,fontWeight:"bold"}},id:"light"},{labels:{format:"{value}",style:{color:r,fontWeight:"bold"}},title:{text:"Pir",style:{color:r,fontWeight:"bold"}},id:"pir"},{labels:{format:"{value}%",style:{color:l,fontWeight:"bold"}},title:{text:"Humidity",style:{color:l,fontWeight:"bold"}},id:"humidity",opposite:!0},{labels:{format:"{value} ppm",style:{color:s,fontWeight:"bold"}},title:{text:"CO2",style:{color:s,fontWeight:"bold"}},id:"co2",opposite:!0}],series:[{name:" ",id:"placeholder-series"}],title:{text:"Data history"},noData:"Add sensors to drop area to see data chart"};var c,d,u,m;c=d=u=m=new Date,c.setDate(c.getDate()-1),d.setDate(d.getDate()-7),u.setMonth(u.getMonth()-1),m.setYear(m.getYear()-1),e.timeFrames=[{text:"Current",icon:"assets/shared/images/latest.svg",params:{newest:20}},{text:"Last Week",icon:"assets/shared/images/week.svg",params:{begin:d.toISOString()}},{text:"Last Month",icon:"assets/shared/images/month.svg",params:{begin:u.toISOString()}},{text:"Last Year",icon:"assets/shared/images/year.svg",params:{begin:m.toISOString()}},{text:"Select range",icon:"assets/shared/images/time-range.svg",params:{begin:null,end:null}}],e.timeFrame=e.timeFrames[0],e.selectTime=function(t){"Select range"===t.text?(e.modalInstance=o.open({templateUrl:"html/templates/select-range.html",controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{timeFrame:t}}}}),e.modalInstance.result.then(function(t){var n=t.timeFrame.params;n.begin&&n.end&&(e.timeFrame=t.timeFrame,e.timeFrame.params.begin=n.begin.toISOString(),e.timeFrame.params.end=n.end.toISOString())})):e.timeFrame=t},e.clearSensors=function(){e.sensors=[],e.sensor=null,e.chartConfig.series=[{name:" ",data:[],legend:{enabled:!1},id:"placeholder-series"}]},e.addSensor=function(t){if(angular.isArray(t)){if(!t.length)return;return void angular.forEach(t,function(t){e.addSensor(t)})}for(var o=0;o<e.chartConfig.series.length;o++)if(e.chartConfig.series[o].id===t.id)return;var c={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:t.room},InfoItem:{"@name":t.name}}}},d=e.timeFrame.params;e.chartConfig.loading=!0,n.send("read",c,d).then(function(n){var o=n[0],c=[];e.sensor=t,e.sensors.push(t);for(var d=0;d<o.values.length;d++)c.push([new Date(o.values[d].time).getTime(),o.values[d].value]);e.chartConfig.series.length&&"placeholder-series"===e.chartConfig.series[0].id&&(e.chartConfig.series=[]);var u;switch(o.type){case"temperature":u=a;break;case"light":u=i;break;case"pir":u=r;break;case"humidity":u=l;break;case"co2":u=s;break;default:u="#707070"}e.chartConfig.series.push({name:o.room+": "+o.name,data:c,tooltip:{valueSuffix:" "+o.suffix},id:o.id,yAxis:o.type,color:u}),e.alert.show=!1,e.alert.message=""},function(t){e.alert.show=!0,e.alert.message=t})["finally"](function(){e.chartConfig.loading=!1})},e.dropSensor=function(e){}}]),angular.module("otaniemi3dApp").controller("PanoramaCtrl",["$scope","$state","$window","$modal","omiMessage","$q","$interval","buildingData",function(e,t,n,o,a,r,i,s){function l(){var e={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:h.roomId}}}};return a.send("read",e).then(function(e){return e})}function c(e){return d(e).then(u).then(m).then(p)}function d(e,t){"undefined"==typeof t&&(t=!0);for(var n={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:h.roomId},InfoItem:[]}}},o=0;o<e.length;o++)n.Object.Object.InfoItem.push({MetaData:{},"@name":e[o].type});return a.send("read",n,{},"",t).then(function(e){return h.sensors=e,h.sensors})}function u(e){var t=r.defer();return i(function(){$("#panorama_obj").length&&(t.resolve(e),n.krpano.elem=$("#panorama_obj")[0])},150),t.promise}function m(e){return e.reduce(function(e,t){return e[t.metaData.ath+","+t.metaData.atv]||(e[t.metaData.ath+","+t.metaData.atv]=[]),e[t.metaData.ath+","+t.metaData.atv].push(t),e},{})}function p(e){var t=$("#panorama_obj")[0];return angular.forEach(e,function(e,n){var o=n.split(",");if(!isNaN(Number(o[0]))&&!isNaN(Number(o[1]))){for(var a="id",r=0;r<e.length;r++)a+="-"+e[r].id;var i={id:a,sensors:e};h.sensorBoxes.push(i),t.call("addsensor("+[i.id,o[0],o[1],f(i)].join(",")+',"'+JSON.stringify(e)+'")')}}),e}function g(e){function t(e,t){n.Object.Object.InfoItem[o].MetaData.InfoItem.push({"@name":t,value:{keyValue:e,"@type":"xs:double"}})}for(var n={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:h.roomId},InfoItem:[]}}},o=0;o<e.length;o++)n.Object.Object.InfoItem.push({MetaData:{InfoItem:[]},"@name":e[o].name}),angular.forEach(e[o].metaData,t);return a.send("write",n)}function f(e){for(var t="",n=e.sensors.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0}),o=0;o<n.length;o++){var a=n[o].values.length?n[o].values[0].value:"",r=n[o].suffix;r=r?" "+r:"";var i="";n[o].metaData.isWritable&&(i="[button onclick=\"krpano.togglePlug('"+n[o].roomId+"', '"+n[o].name+"', '"+n[o].values[0].value+'\')" class="btn black-btn panorama-btn"]Toggle[/button]'),t+=["[tr]","[th]",n[o].name,"[/th]","[td]","[span]",a,r,"[/span]",i,"[/td]","[/tr]"].join("")}var s=['[table class="tooltip-table"]',"[tr]",'[th colspan="2" style="text-align:center"]',"[span]",h.roomId,"[/span]",'[span style="float: right"]','[span class="loading-spinner" style="opacity:0"]','[span class="spinner-icon"][/span]',"[/span]",'[button class="btn refresh-btn"',"onclick=\"krpano.refresh('",e.id,"')\"",'title="Refresh"]','[span class="glyphicon glyphicon-refresh"][/span]',"[/button]","[/span]","[/th]","[/tr]",t,"[/table]"].join("");return s}var h=this;h.roomId=t.params.roomId,h.sensors=[],h.newSensors=[],h["class"]=e.App.fullscreen?"panorama-fullscreen":"",h.sensorBoxes=[],n.krpano={};var v="https://otaniemi3d.cs.hut.fi/omi/node/Objects/K1/"+h.roomId,b="assets/buildings/"+s.currentBuilding.id+"/panorama/"+h.roomId+".xml";h.room={xmlPath:b,url:v,sensors:h.sensors},h.alert={show:!1,message:""},h.addSensors=function(e){h.newSensors=e},h.goBack=function(){n.history.back()},l().then(c),n.krpano.refresh=function(e){return $(".loading-spinner").css("opacity","1"),d(h.sensors,!1).then(function(){for(var t,o=0;o<h.sensorBoxes.length;o++)h.sensorBoxes[o].id===e&&(t=h.sensorBoxes[o]);n.krpano.elem.call("set(plugin[persistent_tooltip].html, "+f(t)+")"),$(".loading-spinner").css("opacity","0")},function(e){$(".loading-spinner").css("opacity","1"),console.log("Error:",e)})},n.krpano.addSensorDialog=function(){var t=n.krpano.elem.get("mouse.x"),a=n.krpano.elem.get("mouse.y"),r=n.krpano.elem.screentosphere(t,a);h.modalInstance=o.open({templateUrl:"html/templates/hotspot-selection.html",scope:e,controller:"ModalCtrl",controllerAs:"modal",resolve:{params:function(){return{room:h.room,alert:h.alert,addSensors:h.addSensors}}}}),h.modalInstance.result.then(function(){if(h.newSensors.length){for(var e=0;e<h.newSensors.length;e++)h.newSensors[e].metaData={ath:r.x,atv:r.y};for(var t=0;t<h.newSensors.length;t++){for(var o=h.newSensors[t],a=!1,i=0;i<h.sensors.length;i++){var s=h.sensors[i];if(n.krpano.elem.call("removehotspot(id-"+s.id+")"),o.id===s.id){angular.merge(s.metaData,o.metaData),a=!0;break}}a||h.sensors.push(o)}var l=m(h.sensors);p(l),g(h.newSensors),h.newSensors=[]}})},n.krpano.togglePlug=function(e,t,n){var o=1-n,r='<?xml version="1.0"?><omi:omiEnvelope xmlns:xs="http://www.w3.org/2001/XMLSchema-instance" xmlns:omi="omi.xsd" version="1.0" ttl="0"><write xmlns="omi.xsd" msgformat="odf"><omi:msg><Objects xmlns="odf.xsd"><Object><id>K1</id><Object><id>'+e+'</id><InfoItem name="'+t+'"><value>'+o+"</value></InfoItem></Object></Object></Objects></omi:msg></write></omi:omiEnvelope>";a.send("write",r)},e.$on("room-selection-change",function(n,o){o&&t.go("panorama",{building:e.App.building.id,roomId:o.id})}),e.$on("$destroy",function(){h.modalInstance&&h.modalInstance.dismiss()})}]),angular.module("otaniemi3dApp").controller("AppCtrl",["$scope","$state","buildingData",function(e,t,n){var o=this;o.navbarCollapse=!0,o.building=n.currentBuilding,o.allBuildings=n.buildings,o.room=null,o.rooms=[],o.floor=1,o.fullscreen=!1,o.navigation=[{state:"heat-map",name:"Heat Map"},{state:"x3dom",name:"3D Model"},{state:"analytics",name:"Analytics"}],o.showViewSelection=!1,o.resetPosition=function(){e.$broadcast("reset-position"),o.room=null},e.$on("$stateChangeSuccess",function(){"heat-map"!==t.current.name&&(o.fullscreen=!1),"google-maps"!==t.current.name?o.showViewSelection=!0:o.showViewSelection=!1}),e.$watch(function(){return n.currentBuilding},function(e,t){e!==t&&(o.building=e,o.building?o.rooms=o.building.rooms:o.rooms=[])}),e.$watch(function(){return o.room},function(t,n){t!==n&&(t?o.floor=t.floor:o.floor=1,e.$broadcast("room-selection-change",t))});var a=e.$watch(function(){return n.buildings},function(e){e&&(o.allBuildings=e,a())})}]),angular.module("otaniemi3dApp").controller("ModalCtrl",["$scope","$window","$modalInstance","params",function(e,t,n,o){function a(e){console.log(e)}var r=this;r.params=o,r.smallDevice=t.innerWidth<769,r.ok=function(){"function"==typeof r.params.validate?r.params.validate(r.params)?n.close(r.params):a(r.params.errorMsg):n.close(r.params)},r.cancel=function(){n.dismiss("cancel")}}]),angular.module("otaniemi3dApp").directive("heatMap",["valueConverter","$q","$rootScope","omiMessage",function(e,t,n,o){return{restrict:"E",scope:{floorplan:"=",selectedRoom:"=",sensorType:"=",building:"="},link:function(a,r){function i(e){var n=t.defer();return e.svg?n.resolve(e):d3.xml("assets/buildings/"+a.building.id+"/"+e.url,"image/svg+xml",function(t){t?(e.svg=t.documentElement,n.resolve(e)):n.reject("Error while fetching a floorplan")}),n.promise}function s(e){e.rooms=[],e.data=[],e.translate=[0,0],e.scale=1;var t=r[0].appendChild(e.svg);return t=d3.select(t).attr("width","100%").attr("height","100%").attr("pointer-events","all").attr("id","floorplan"),t.selectAll("path").each(function(){var e=d3.select(this);e.attr("data-room-id")||e.attr("pointer-events","none")}),t.selectAll("text").attr("pointer-events","none"),g=d3.behavior.zoom().scaleExtent([.5,10]).scale(e.scale).translate(e.translate).on("zoom",function(){t.select("g").attr("transform",["translate(",d3.event.translate,")","scale(",d3.event.scale,")"].join("")),e.scale=d3.event.scale,e.translate=d3.event.translate}),t.call(g),n.$broadcast("floorplan-loaded"),f=!0,p(a.selectedRoom),e}function l(e){var t={Object:{id:{keyValue:"K1"},Object:[]}};return d3.select(e.svg).selectAll("[data-room-id]").each(function(){t.Object.Object.push({id:{keyValue:d3.select(this).attr("data-room-id")}})}),o.send("read",t).then(function(t){return e.data=t,e},function(){return e.data=e.data||[],e})}function c(e){return d3.select(e.svg).selectAll("[data-room-id]").datum(function(){var t=d3.select(this).datum();if(t&&t.sensors.length)return t;for(var n,o={sensors:[],metaData:null},a=d3.select(this).attr("data-room-id"),r=0;r<e.data.length;r++){var i=e.data[r];i.roomId===a&&(o.sensors.push(i),n=i.room)}return o.room=n?n:a,o.roomId=a,e.rooms.push({name:o.room,id:o.roomId}),o}),e}function d(t){d3.select(t.svg).selectAll("[data-room-id]").each(function(){for(var t=d3.select(this).datum(),n=0;n<t.sensors.length;n++)if(t.sensors[n].type===a.sensorType.name){var o=t.sensors[n],r=o.values[0].value,i=e.getColor(o.type,r);d3.select(this).style("fill",i.rgb).style("fill-opacity",i.opacity)}})}function u(e){var t=d3.select(a.floorplan.svg),n=t.node().getBoundingClientRect(),o=[n.width/2,n.height/2],r=e.node(),i=r.getBBox(),s=i.x+i.width/2,l=i.y+i.height/2,c=1.6,d=[o[0]-s*c,o[1]-l*c];m(c,d)}function m(e,t,n){n=n||1e3,g&&(a.floorplan.translate=t,a.floorplan.scale=e,d3.select(a.floorplan.svg).transition().duration(n).call(g.translate(t).scale(e).event))}function p(e){d3.select(a.floorplan.svg).selectAll("[data-room-id]").each(function(){var t=d3.select(this);t.style("stroke-width",null).style("stroke",null).style("stroke-opacity",null),t.attr("data-room-id")===e.id&&(t.style("stroke-width","15").style("stroke","#ffcc00").style("stroke-opacity","0").transition().ease("cubic-in-out").style("stroke-opacity","1"),u(t))})}var g,f=!1;i(a.floorplan).then(s).then(l).then(c).then(d),a.$on("reset-position",function(){m(1,[0,0])}),a.$watch("selectedRoom",p),a.$watch("sensorType",function(){f&&d(a.floorplan)})}}}]),angular.module("otaniemi3dApp").directive("tooltip",["$state","valueConverter","omiMessage","$timeout",function(e,t,n,o){return{restrict:"E",template:['<table class="tooltip-table">',"<tr>",'<th colspan="2" style="text-align:center">',"<span>{{tooltip.room}}</span>",'<span style="float: right">','<span class="loading-spinner"',"ng-style=\"{'opacity': tooltip.isLoading ? 1 : 0}\">",'<span class="spinner-icon"></span>',"</span>",'<button class="btn refresh-btn"','ng-click="tooltip.refresh()"','title="Refresh">','<span class="glyphicon glyphicon-refresh"></span>',"</button>","</span>","</th>","</tr>","<tr ng-repeat=\"sensor in tooltip.sensors | orderBy: 'name'\"",'ng-style="tooltip.getSensorStyle(sensor)">',"<th>{{sensor.name}}</th>","<td>","<span>","{{sensor.values[0].value}} {{sensor.suffix}}","</span>",'<button ng-click="tooltip.togglePlug(sensor)"','ng-disabled="tooltip.togglingPlug"','ng-if="sensor.metaData.isWritable"','class="btn black-btn panorama-btn"','title="Toggle plug">',"Toggle","</button>","</td>","</tr>","<tr>",'<td colspan="2">','<button ng-click="tooltip.openPanorama(tooltip.roomId)"','ng-show="tooltip.hasPanorama"','class="btn black-btn panorama-btn"','title="Open panorama picture">',"360°",'<span class="glyphicon glyphicon-camera"></span>',"</button>",'<i class="tooltip-caption">{{tooltip.caption}}',"</i>","</td>","</tr>","</table>"].join(""),scope:{sensorType:"="},controller:function(){var a=this;this.sensors=[],this.room="",this.roomId="",this.caption="Downloading sensor data...",this.isLocked=!1,this.togglingPlug=!1,this.roomsWithPanorama=["Room-147a","Room-238d","Room-237c","Room-235","Room-232a","2nd Floor Corridor Start","2nd Floor Corridor Middle","2nd Floor Corridor End","Corridor Cafeteria Side","Corridor Entrance Side","Cafeteria","Entrance"],this.hasPanorama=!1,function(){var e=!1,t=!1,n=!0;Object.defineProperty(a,"isLoading",{get:function(){return n},set:function(a){e||a!==!0?a===!0?(n=a,t=!1):e?t=!0:n=!1:(n=!0,e=!0,t=!1,o(function(){e=!1,t&&(n=!1)},600))}})}(),this.refresh=function(){for(var e={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:a.roomId},InfoItem:[]}}},t=0;t<a.sensors.length;t++)e.Object.Object.InfoItem.push({MetaData:{},"@name":a.sensors[t].type});return a.isLoading=!0,n.send("read",e,{},"",!1).then(function(e){return a.sensors=e,a.isLoading=!1,a.sensors},function(e){a.isLoading=!1,console.log("Error:",e)})},this.openPanorama=function(t){e.go("panorama",{roomId:t})},this.getSensorStyle=function(e){var n,o=e.values[0].value;return n=e.type===a.sensorType.name?t.getColor(e.type,o).rgbaString:"",{"background-color":n}},this.togglePlug=function(e){var t=1-e.values[0].value,o='<?xml version="1.0"?><omi:omiEnvelope xmlns:xs="http://www.w3.org/2001/XMLSchema-instance" xmlns:omi="omi.xsd" version="1.0" ttl="0"><write xmlns="omi.xsd" msgformat="odf"><omi:msg><Objects xmlns="odf.xsd"><Object><id>K1</id><Object><id>'+e.roomId+'</id><InfoItem name="'+e.mac+'"><value>'+t+"</value></InfoItem></Object></Object></Objects></omi:msg></write></omi:omiEnvelope>";a.togglingPlug=!0,n.send("write",o).then(function(){a.togglingPlug=!1,e.values[0].value=t},function(){a.togglingPlug=!1})}},controllerAs:"tooltip",bindToController:!0,link:function(e,t,o,a){function r(e){for(var t={Object:{id:{keyValue:"K1"},Object:{id:{keyValue:e.roomId},InfoItem:[]}}},o=0;o<e.sensors.length;o++)t.Object.Object.InfoItem.push({"@name":e.sensors[o].type,MetaData:{keyValue:null}});e.metaData=!0,a.isLoading=!0,n.send("read",t,{},"",!1).then(function(t){for(var n=0;n<t.length;n++)for(var o=0;o<e.sensors.length;o++)if(t[n].id===e.sensors[o].id){t[n].metaData&&(e.sensors[o].metaData=t[n].metaData);break}a.isLoading=!1},function(e){a.isLoading=!1,console.log("Error while fetching sensor metadata:",e)})}function i(e){d3.select(t[0]).style("display",null),!e||e.metaData||a.isLocked||r(e)}function s(n){a.isLocked||(i(n),n&&(a.isLoading=!1,a.caption="Click to lock the tooltip",e.$apply(function(){a.sensors=n.sensors,a.room="",n.room&&(a.room=n.room),n.roomId&&(a.roomId=n.roomId,a.roomsWithPanorama.indexOf(n.roomId)>-1?a.hasPanorama=!0:a.hasPanorama=!1)})),d3.event.pageY>window.innerHeight/2?d3.select(t[0]).style("bottom",window.innerHeight-d3.event.pageY+"px").style("top","auto"):d3.select(t[0]).style("top",d3.event.pageY-10+"px").style("bottom","auto"),d3.select(t[0]).style("left",d3.event.pageX+"px").style("right","auto"))}function l(){a.isLocked||d3.select(t[0]).style("display","none")}function c(){a.isLocked=!1,s(),a.isLocked=!0,d3.event.preventDefault()}function d(){d3.event.defaultPrevented||(a.isLocked=!1,l())}d3.select(t[0]).style("display","none"),d3.select(t.parent()[0]).selectAll("[data-room-id]").on("mouseover",i).on("mousemove",s).on("mouseout",l).on("mouseup",c),d3.select(t.parent()[0]).select("#floorplan").on("mousedown.tooltip",d),e.$on("$destroy",function(){d3.select(t.parent()[0]).selectAll("[data-room-id]").on("mouseover",null).on("mousemove",null).on("mouseout",null).on("click",null)})}}}]),angular.module("otaniemi3dApp").directive("sensorTree",["$document","$http","omiMessage",function(e,t,n){return{template:"<div></div>",restrict:"E",scope:{selectSensor:"=",dragSensor:"=",search:"=",checkbox:"=",rootUrl:"=",error:"="},link:function(o,a,r){function i(e,t){return t?s.get_node(e).original:s.get_node(e)}a.jstree({plugins:["sort",o.checkbox?"checkbox":"","string"==typeof r.search?"search":"","string"==typeof r.dragSensor?"dnd":""],search:{show_only_matches:!0,show_only_matches_children:!0},dnd:{is_draggable:function(e){var t=e[0];return"sensor"===t.original.type}},core:{check_callback:!0,worker:!1,data:function(e,a){function r(e,t,n){t.call(e,n),o.error.show=!1,o.error.message=""}function i(e,t,n){t.call(e,n.errorNode),o.error.show=!0,o.error.message=n.errorMsg}var s,l,c,d=[],u={errorNode:[{text:"Error"}],errorMsg:"Error when opening a tree node. Please close and reopen the node to try again."},m=o.rootUrl.split("/");"#"===e.id?(m=m[m.length-1].length?m[m.length-1]:m[m.length-2],"K1"===m?(s="assets/shared/images/icon-building.svg",l="building"):(s="assets/shared/images/icon-room.svg",l="room"),d=[{id:m,text:m.split("-").join(" "),children:!0,type:l,icon:s,state:{opened:!0}}],a.call(this,d)):"sensor"===e.original.type?t.get(e.original.url).success(function(e){var t=n.parseInfoItem(e);t.length&&(d=[{values:t,text:t[0].value+"  --  "+t[0].time.toISOString(),icon:!1,type:"value"}]),r(this,a,d)}).error(function(){i(this,a,u)}):"room"===e.original.type?(c=o.rootUrl,"#"!==e.parent&&(c+=e.id),t.get(c).success(function(t){for(var o=n.parseObject(t),i=0;i<o.infoItems.length;i++){var s=o.infoItems[i];d.push({id:s+"-"+e.id,room:o.id,name:s,text:s.charAt(0).toUpperCase()+s.slice(1),children:!0,icon:"assets/shared/images/icon-"+s+".svg",type:"sensor",url:c+"/"+s})}r(this,a,d)}).error(function(){i(this,a,u)})):"building"===e.original.type&&(c=o.rootUrl,"#"!==e.parent&&(c+=e.id),t.get(c).success(function(e){for(var t=n.parseObject(e),i=0;i<t.objects.length;i++){var s=t.objects[i];d.push({id:s,text:s.split("-").join(" "),children:!0,icon:"assets/shared/images/icon-room.svg",type:"room",url:o.rootUrl+s})}r(this,a,d)}).error(function(){i(this,a,u),e.children=!0}))},themes:{responsive:!0}}});var s=a.jstree(!0);a.on("after_close.jstree",function(e,t){t.node.children=!0,i(t.node.id).state.loaded=!1}).on("select_node.jstree",function(){if("string"==typeof r.selectSensor){var e=[];angular.forEach(s.get_selected(!0),function(t){"sensor"===t.original.type&&e.push(t.original)}),o.selectSensor(e)}}),e.on("dnd_stop.vakata",function(e,t){var n=$(t.event.target);if(n.closest("#drop-area").length){var a=i(t.data.nodes[0],!0);o.dragSensor(a)}}).on("dnd_move.vakata",function(e,t){var n=$(t.event.target);n.closest(a).length||(n.closest("#drop-area").length?t.helper.find(".jstree-icon").removeClass("jstree-er").addClass("jstree-ok"):t.helper.find(".jstree-icon").removeClass("jstree-ok").addClass("jstree-er"));
}),"string"==typeof o.search&&o.$watch("search",function(e){e?s.search(e):s.clear_search()}),o.$on("$destroy",function(){$.jstree.destroy(),e.off("dnd_stop.vakata dnd_move.vakata")})}}}]),angular.module("otaniemi3dApp").directive("panorama",function(){return{restrict:"E",scope:{room:"="},link:function(e){embedpano({xml:e.room.xmlPath,id:"panorama_obj",target:"room-panorama",html5:"only",passQueryParameters:!0,consolelog:!0,debugmode:!0,initvars:{krpanodir:"../../../krpano"}}),e.$on("$destroy",function(){removepano("panorama_obj")})}}}),angular.module("otaniemi3dApp").directive("legendbar",["valueConverter",function(e){return{restrict:"E",template:['<p id="legendMinText" class="legendText"></p>','<svg id="legendContainingSvg">',"<g>","<defs>",'<lineargradient id="legendGradient"','x1="0%" x2="0%" y1="0%" y2="100%">',"<stop></stop>","</lineargradient>","</defs>","</g>",'<rect id="gradient-rect"','class="legend-rect"','fill="url(#legendGradient)"','rx="10" ry="10"',"ng-show=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<rect id="binary-rectTop"','class="binary-rect legend-rect"','rx="10" ry="10"',"ng-hide=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<rect id="binary-rect-bottom"','class="binary-rect legend-rect"','rx="10" ry="10"',"ng-hide=\"legendbar.sensorType.name !== 'pir'\"","ng-cloak>","</rect>",'<line id="legendLine"></line>','<text id="legendLineText"></text>',"</svg>",'<p id="legendMaxText" class="legendText"></p>'].join(""),scope:{sensorType:"="},controller:function(){},controllerAs:"legendbar",link:function(t){function n(){s.style("visibility","visible"),l.style("visibility","visible")}function o(){s.style("visibility","hidden"),l.style("visibility","hidden")}function a(){var n=[0,0],o=d3.select("#gradient-rect").node();n=d3.mouse(o);var a=o.getBBox().height,r=(n[1]-m)/a,i=e.valueAtPercent(t.sensorType.name,r)+e.getValueUnit(t.sensorType.name),c=Math.min(a-3,Math.max(n[1],7));s.attr("y1",c).attr("y2",c),l.attr("y",c+3).text(i)}function r(){d3.select("#legendMinText").style("margin","0px").text(e.temperatureMin+e.getValueUnit(t.sensorType.name)),d3.select("#legendContainingSvg").attr("width",d).attr("height","100%"),d3.select("#legendMaxText").text(e.temperatureMax+e.getValueUnit(t.sensorType.name)),d3.select("#gradient-rect").attr("x",u).attr("y",m).attr("width",c).attr("height","99%"),s=d3.select("#legendLine").attr("x1",u).attr("y1",m).attr("x2",u+c).attr("y2",m).attr("stroke","black").attr("stroke-width",1).style("visibility","hidden"),l=d3.select("#legendLineText").attr("x",u+c).attr("y",m).style("visibility","hidden").text(""),d3.select("#gradient-rect").on("mouseover",n).on("mousemove",a).on("mouseout",o);for(var r,i,p,g,f=160,h=0,v=.3,b=1,y=35,x=1/(y-1),w=(h-f)/(y-1),k=(b-v)/(y-1),M=[],$=0;y>$;$++)r=f+w*$,i=d3.hsl(r,1,.6).toString(),p=v+k*$,g=0+x*$,M.push({rgb:i,opacity:p,percent:g});var I=d3.select("#legendGradient").selectAll("stop").data(M);I.enter().append("stop"),I.attr("offset",function(e){return e.percent}).attr("stop-color",function(e){return e.rgb}).attr("stop-opacity",function(e){return e.opacity});var S=e.getColor("occupancy",0),C=e.getColor("occupancy",1);d3.select("#binary-rectTop").attr("x",u).attr("y",m).attr("width",c).attr("height","50%").attr("fill",S.rgb).attr("fill-opacity",S.opacity),d3.select("#binary-rect-bottom").attr("x",u).attr("y","50%").attr("width",c).attr("height","50%").attr("fill",C.rgb).attr("fill-opacity",C.opacity)}function i(t){var n,o;switch(t){case"temperature":n=e.temperatureMin,o=e.temperatureMax;break;case"humidity":n=e.humidityMin,o=e.humidityMax;break;case"co2":n=e.co2Min,o=e.co2Max;break;case"pir":n=e.occupancyMin,o=e.occupancyMax;break;case"light":n=e.lightMin,o=e.lightMax;break;case"pir":n=e.occupancyMin,o=e.occupancyMax}n+=e.getValueUnit(t),o+=e.getValueUnit(t),d3.select("#legendMinText").text(n),d3.select("#legendMaxText").text(o)}var s,l,c=20,d=80,u=0,m=1;r(),t.$watch("sensorType.name",function(e){e&&i(e)})}}}]),angular.module("otaniemi3dApp").directive("dateRange",function(){return{restrict:"EA",scope:{ngModel:"=",current:"="},link:function(e,t){var n=e.ngModel;n&&(n.begin=null,n.end=null),t.dateRangePicker({inline:!0,container:t,alwaysOpen:!0,singleMonth:!0,showShortcuts:!1,startOfWeek:"monday"}).bind("datepicker-change",function(e,t){n&&(n.begin=t.date1,n.end=t.date2)}),t.find(".footer").remove(),e.$watch("current",function(e){if(e){var n=e.begin||(new Date).toISOString(),o=e.end||(new Date).toISOString();n=n.split("T")[0],o=o.split("T")[0],console.log(e.begin),console.log(o),t.data("dateRangePicker").setDateRange(n,o)}}),e.$on("destroy",function(){t.data("dateRangePicker").destroy()})}}}),angular.module("otaniemi3dApp").service("valueConverter",function(){var e=this;this.temperatureMin=15,this.temperatureMax=35,this.co2Min=350,this.co2Max=5e3,this.lightMin=30,this.lightMax=1e4,this.pirMin=0,this.pirMax=30,this.humidityMin=30,this.humidityMax=70,this.occupancyMin="no",this.occupancyMax="yes",this.getColor=function(t,n){var o,a,r=t.toLowerCase();switch(r){case"temperature":o=e.temperatureMin,a=e.temperatureMax;break;case"co2":o=e.co2Min,a=e.co2Max;break;case"light":o=e.lightMin,a=e.lightMax;break;case"pir":o=e.pirMin,a=e.pirMax;break;case"humidity":o=e.humidityMin,a=e.humidityMax}var i;"occupancy"===r||"pir"===r||"occupied"===r?i=0>=n?0:1:(i=Math.min((n-o)/(a-o),1),i=Math.max(i,0));var s,l,c,d,u=160,m=0,p=.3,g=1;s=u+i*(m-u),l=d3.hsl(s,1,.6).toString(),c=p+i*(g-p);var f=d3.hsl(s,1,.6).rgb();return d="rgba("+f.r+","+f.g+","+f.b+","+c+")",{rgb:l,opacity:c,rgbaString:d}},this.valueAtPercent=function(t,n){var o,a;switch(t){case"temperature":o=e.temperatureMin,a=e.temperatureMax;break;case"co2":o=e.co2Min,a=e.co2Max;break;case"light":o=e.lightMin,a=e.lightMax;break;case"pir":return.5>=n?"no":"yes";case"humidity":o=e.humidityMin,a=e.humidityMax;break;case"occupancy":return.5>=n?"no":"yes"}var r=(o+n*(a-o))/1;return 0>r?Math.ceil(r):Math.floor(r)},this.getValueUnit=function(e){switch(e){case"temperature":return"°C";case"co2":return"ppm";case"light":return"lux";case"humidity":return"%";default:return""}}}),angular.module("otaniemi3dApp").service("omiMessage",["$http","$q","$interval","dataStorage","JXON",function(e,t,n,o,a){function r(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=l(e,'//*[local-name()="Object"]');0===t.length&&console.log("Couldn't fetch any sensor data from the server.");for(var n=[],o=0;o<t.length;o++){var a=t[o].getElementsByTagName("id");if(a.length>0){a=a[0].textContent;for(var r=t[o].children,i=0;i<r.length;i++)if("InfoItem"===r[i].tagName){for(var c,u=r[i].getAttribute("name"),m=r[i].children,p=[],g={},f=0;f<m.length;f++)if("value"===m[f].tagName){var h,v=m[f].textContent,b=m[f].getAttribute("unixTime"),y=m[f].getAttribute("dateTime");v&&(v=Math.round(100*Number(v))/100),h=y?new Date(y).getTime():new Date(1e3*Number(b)),!isNaN(v)&&h&&p.push({value:v,time:h})}else"MetaData"===m[f].tagName&&(c=m[f]);if(c){var x=document.createElement("div");x.appendChild(c),g=d.parseMetaData(x.innerHTML)}if(u){s(p);var w;switch(u.toLowerCase()){case"co2":w="CO2";break;case"pir":w="Occupancy";break;default:w=u.charAt(0).toUpperCase()+u.slice(1)}var k;switch(u.toLowerCase()){case"temperature":k="°C";break;case"co2":k="ppm";break;case"light":k="lux";break;case"humidity":k="%";break;case"pir":k="";break;default:k=""}g.isWritable&&(w=u),n.push({id:u+"-"+a,type:u,room:a.split("-").join(" "),roomId:a,name:w,values:p,suffix:k,metaData:g})}}}}return n}function i(e,t,n){var o={"omi:omiEnvelope":{"@xmlns:xsi":"http://www.w3.org/2001/XMLSchema-instance","@xmlns:omi":"omi.xsd","@version":"1.0","@ttl":"0"}},r=o["omi:omiEnvelope"]["omi:"+t]={"@msgformat":"odf","omi:msg":!0};angular.forEach(n,function(e,t){r["@"+t]=e});var i=a.createXML(o),s=document.createElementNS("odf.xsd","Objects");s=s.appendJXON(e),$(i.documentElement).find("omi\\:msg").append(s);var l=i.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"');return i.insertBefore(l,i.firstChild),(new XMLSerializer).serializeToString(i)}function s(e){e.sort(function(e,t){return e.time-t.time})}function l(e,t){for(var n=new XPathEvaluator,o=n.createNSResolver(null===e.ownerDocument?e.documentElement:e.ownerDocument.documentElement),a=n.evaluate(t,e,o,0,null),r=[],i=a.iterateNext();i;)r.push(i),i=a.iterateNext();return r}var c={},d=this;this.send=function(n,a,s,l,d){var u=t.defer(),m="https://otaniemi3d.cs.hut.fi/omi/node/";s=s||{},l=l||"","undefined"==typeof d&&(d=!0);var p;return"string"==typeof a?p=a:"object"==typeof a&&(p=i(a,n,s)),c[p]?u.reject():(c[p]=!0,e.post(m,p,{headers:{"Content-Type":"application/xml"},ignoreLoadingBar:!d}).then(function(e){var t=r(e.data);u.resolve(t),o.sensors=t},function(e){var t;404===e.status?(t="Couldn't find such sensors or values.",console.log(t),u.reject(t)):(t="Failed to fetch sensor data. Please try again",console.log(t),u.reject(t))})["finally"](function(){c[p]=!1})),u.promise},d.parseInfoItem=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=[];return $(e).find("value").each(function(){var e=$(this).attr("unixTime");e?e=new Date(1e3*Number(e)):(e=$(this).attr("dateTime"),e=new Date(e));var n=$(this).text();n&&(n=Math.round(100*Number(n))/100),t.push({value:n,time:e})}),t},this.parseMetaData=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t={};return $(e).find("InfoItem").each(function(){t[$(this).attr("name")]=$(this).find("value").text()}),t},this.parseObject=function(e){e=(new DOMParser).parseFromString(e,"text/xml");var t=$(e).find(":root"),n=t.children("id").first().text(),o=[],a=[];return t.children("Object").each(function(){o.push($(this).children("id").text())}),t.children("InfoItem").each(function(){a.push($(this).attr("name"))}),{id:n,text:n.split("-").join(" "),infoItems:a,objects:o}}}]),angular.module("otaniemi3dApp").service("dataStorage",function(){var e=this;e.sensors=[]}),angular.module("otaniemi3dApp").service("JXON",function(){function e(a,r,i){var s,l,c=r.namespaceURI;if(i.constructor===String||i.constructor===Number||i.constructor===Boolean){if(r.appendChild(a.createTextNode(i.toString())),i===i.valueOf())return}else i.constructor===Date&&r.appendChild(a.createTextNode(i.toGMTString()));for(var d in i)if(s=i[d],!(isFinite(d)||s instanceof Function))if(d===t)null!==s&&s!==!0&&r.appendChild(a.createTextNode(s.constructor===Date?s.toGMTString():String(s)));else if(d===n)for(var u in s)r.setAttribute(u,s[u]);else if(d.charAt(0)===o)r.setAttribute(d.slice(1),s);else if(s.constructor===Array)for(var m=0;m<s.length;m++)l=c?a.createElementNS(c,d):a.createElement(d),e(a,l,s[m]),r.appendChild(l);else l=c?a.createElementNS(c,d):a.createElement(d),s instanceof Object?e(a,l,s):null!==s&&s!==!0&&l.appendChild(a.createTextNode(s.toString())),r.appendChild(l)}var t="keyValue",n="keyAttributes",o="@";Element.prototype.appendJXON=function(t){var n=document.createElementNS(this.namespaceURI,this.nodeName);return e(document,n,t),this.parentNode&&this.parentNode.replaceChild(n,this),n},this.createXML=function(t,n,o,a){var r=document.implementation.createDocument(n||null,o||"",a||null);return o?e(r,r.documentElement,t):e(r,r,t),r}}),angular.module("otaniemi3dApp").service("buildingData",function(){var e=this;e.buildings=null,e.currentBuilding=null});